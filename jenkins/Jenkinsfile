pipeline {
    agent {
        docker {
            image 'python:3.10-slim'
            args '-v $PWD:/workspace'
        }
    }

    environment {
        VENV_DIR = ".venv"
        PYTHONPATH = "src"
        REPORTS_DIR = "jenkins/reports"
    }

    stages {

        stage('1 Checkout') {
            steps {
                echo "üì¶ Clonando el repositorio..."
                checkout scm
            }
        }

        stage('2 Configurar entorno') {
            steps {
                echo "‚öôÔ∏è Creando entorno virtual e instalando dependencias..."
                sh '''
                python -m venv ${VENV_DIR}
                . ${VENV_DIR}/bin/activate
                pip install --upgrade pip setuptools wheel
                pip install -r requirements.txt
                '''
            }
        }

        stage('3 Validaci√≥n de calidad') {
            steps {
                echo " Ejecutando validaciones de c√≥digo..."
                sh '''
                . ${VENV_DIR}/bin/activate
                python validate.py
                '''
            }
        }

        stage('4 Pruebas unitarias') {
            steps {
                echo " Ejecutando pruebas unitarias..."
                sh '''
                . ${VENV_DIR}/bin/activate
                mkdir -p ${REPORTS_DIR}
                pytest tests/ -v --disable-warnings --maxfail=1 --junitxml=${REPORTS_DIR}/pytest_report.xml
                '''
            }
        }

        stage('5 Ejecuci√≥n del pipeline') {
            steps {
                echo " Ejecutando pipeline de entrenamiento..."
                sh '''
                . ${VENV_DIR}/bin/activate
                python -m src.pipelines.pipeline_train
                '''
            }
        }

        stage('6 Evaluaci√≥n y registro del modelo') {
            steps {
                echo " Registrando el mejor modelo..."
                sh '''
                . ${VENV_DIR}/bin/activate
                python -m src.models.model_registry
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente."
            mail to: 'nicolasjm05@gmail.com',
                 subject: "‚úÖ √âxito: Pipeline MLOps completado (${env.BUILD_TAG})",
                 body: """El pipeline se ejecut√≥ correctamente.
                 \nExperimento: membresias_premium_models
                 \nLogs: ${env.BUILD_URL}
                 """
        }
        failure {
            echo "‚ùå Fall√≥ el pipeline."
            mail to: 'nicolasjm05@gmail.com',
                 subject: "‚ùå Error: Fall√≥ el pipeline (${env.BUILD_TAG})",
                 body: """El pipeline fall√≥ en la etapa: ${env.STAGE_NAME}.
                 \nRevisa los logs: ${env.BUILD_URL}
                 """
        }
    }
}

